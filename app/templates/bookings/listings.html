{% extends 'base.html' %}
{% block content %}
    <style>
        .container {
            width: 60%;
            margin: 0 auto;
            font-family: Arial, sans-serif;
        }
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .results {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            cursor: pointer;
        }
        .main-image {
            max-width: 150px;
            cursor: pointer;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-item {
            height: 400px;
        }
        .carousel-inner {
            position: relative;
            height: 400px;
            overflow: hidden;
            display: flex;
        }
        .carousel-indicators li {
            background-color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search...">
            <button onclick="filterResults()">Search</button>
        </div>
        
        <div id="resultsContainer">
        {% for item in items %}
        <div class="results" onclick="handleClick(event, {{ item.id }})">
            <div>
                <img src="{{ item.main_image_url }}" alt="Main Image" class="main-image" onclick="event.stopPropagation(); showModal({{ item.image_urls | safe }});">
            </div>
            <div>
                <div class="title">{{ item.depart_location }}</div>
                <div class="price">{{ item.fair_cost }}</div>
                <div class="delivery">{{ item.destination_location }}</div>
                <div>Save up to 10% with multi-buy</div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Image Gallery</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                        <ol class="carousel-indicators" id="carouselIndicators"></ol>
                        <div class="carousel-inner" id="carouselInner"></div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Bootstrap modal with jQuery
        $(document).ready(function() {
            $('.select2-multiple').select2({ 
                width: 'resolve', // Automatically adjust width 
                placeholder: 'Select an option', });

            $('#imageModal .btn-close, #imageModal .btn-secondary').on('click', function() {
                console.log("Close button clicked");
                $('#imageModal').modal('hide');
            });
        });

        // Shows pop-up with images attached to specific booking
        function showModal(imageUrls) {
            console.log("showModal called with imageUrls:", imageUrls);

            var carouselInner = document.getElementById('carouselInner');
            var carouselIndicators = document.getElementById('carouselIndicators');
            carouselInner.innerHTML = '';
            carouselIndicators.innerHTML = '';

            imageUrls.forEach((imageUrl, index) => {
                var activeClass = (index === 0) ? ' active' : '';

                // Create carousel item
                var div = document.createElement('div');
                div.className = 'carousel-item' + activeClass;
                var img = document.createElement('img');
                img.className = 'd-block w-100';
                img.src = imageUrl;
                div.appendChild(img);
                carouselInner.appendChild(div);

                // Create carousel indicators
                var li = document.createElement('li');
                li.setAttribute('data-bs-target', '#carouselExampleIndicators');
                li.setAttribute('data-bs-slide-to', index);
                if (index === 0) {
                    li.className = 'active';
                }
                carouselIndicators.appendChild(li);
            });

            var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
        }

        function filterResults() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const results = document.querySelectorAll('.results');

            results.forEach(result => {
                const title = result.querySelector('.title').textContent.toLowerCase();
                const price = result.querySelector('.price').textContent.toLowerCase();
                const delivery = result.querySelector('.delivery').textContent.toLowerCase();

                if (title.includes(searchTerm) || price.includes(searchTerm) || delivery.includes(searchTerm)) {
                    result.style.display = 'flex';
                } else {
                    result.style.display = 'none';
                }
            });
        }

        // Only redirects when image is NOT clicked
        function handleClick(event, id) {
            if (!event.target.classList.contains('main-image')) {
                window.location.href = '/bookings/listing/' + id;
            }
        }
    </script>
</body>
</html>
{% endblock %}
