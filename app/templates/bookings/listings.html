{% extends 'base.html' %}
{% block content %}
<div class="my_container my-4">
    <div class="results-container">
        <div class="col-md-6 text-start mb-3 d-flex align-items-center flex-md-nowrap flex-wrap" id="dateContainer">
            <label for="departureDate" class="form-label me-2">Departure Date:</label>
            <input type="date" class="form-control me-2 flex-grow-1" id="departDate" name="departDate" required>
            <button type="button" class="btn btn-warning" id="resetDate">
                <i class="fa-solid fa-rotate-right"></i> Reset Date
            </button>
        </div>
        
        <div class="text-end mb-3">
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fa-solid fa-filter"></i> Filter
            </button>
        </div>
    </div>
    <!-- This div will be targeted for updating the filtered results -->
    <div id="filteredResults">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Main Image</th>
                    <th>Depart Location</th>
                    <th>Price</th>
                    <th>Destination Location</th>
                    <th>Arrival Time</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr class="results" onclick="handleClick(event, {{ item.id }})">
                    <td><img src="{{ item.main_image_url }}" class="main-image" alt="Main Image" onclick="event.stopPropagation(); showModal({{ item.image_urls | safe }});"></td>
                    <td>{{ item.depart_location }}</td>
                    <td>{{ item.fair_cost }}</td>
                    <td>{{ item.destination_location }}</td>
                    <td>{{ item.destination_time }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Pagination Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('bookings.listings', page=page - 1) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            {%- for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('bookings.listings', page=p) }}">{{ p }}</a>
                </li>
            {%- endfor %}

            {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('bookings.listings', page=page + 1) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Gallery</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                    <ol class="carousel-indicators" id="carouselIndicators"></ol>
                    <div class="carousel-inner" id="carouselInner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel"><i class="fa-solid fa-filter"></i> Filter Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="filter-form">
                    <div class="mb-3">
                        <label for="depart_location" class="form-label">Depart Location:</label>
                        <select class="form-control select2-multiple" id="depart_location" name="depart_location[]" multiple="multiple"></select>
                    </div>
                    <div class="mb-3">
                        <label for="destination_location" class="form-label">Destination Location:</label>
                        <select class="form-control select2-multiple" id="destination_location" name="destination_location[]" multiple="multiple"></select>
                    </div>
                    <div class="form-group">
                        <label for="min_fair_cost" class="form-label">Minimum Fair Cost:</label>
                        <input type="number" class="form-control" id="min_fair_cost" name="min_fair_cost">
                    </div>
                    <div class="form-group">
                        <label for="max_fair_cost" class="form-label">Maximum Fair Cost:</label>
                        <input type="number" class="form-control" id="max_fair_cost" name="max_fair_cost">
                    </div>
                    <div class="form-group">
                        <label for="transport_type" class="form-label">Transport Type:</label>
                        <input type="text" class="form-control" id="transport_type" name="transport_type" value="Airplane" disabled>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div>
                    <button type="button" class="btn btn-primary" id="apply-filters">Apply Filters</button>
                    <button type="button" class="btn btn-warning" id="reset-filters">Reset Filters</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        #dateContainer {
            flex-direction: column;
            align-items: flex-start;
        }
        #dateContainer .form-label,
        #dateContainer .form-control,
        #dateContainer .btn {
            width: 100%;
            margin-bottom: 10px;
        }
    }
    
    .results {
        cursor: pointer;
        transition: transform 0.3s;
    }
    
    .results:hover {
        transform: scale(1.05);
    }
    
    .main-image {
        max-width: 150px;
        height: auto;
    }
    
    .modal-footer {
        display: flex;
        justify-content: space-between;
    }
    
    .datepicker {
        position: relative;
    }
    
    .datepicker .input-group-append {
        cursor: pointer;
    }
    
    .results-container {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
    }
    </style>
<script>
    $(document).ready(function () {
        $('.select2-multiple').select2({
            placeholder: "Select locations",
            dropdownParent: $('#filterModal'),
            width: '100%'
        });

        const locations = JSON.parse('{{ locations|tojson|safe }}');
        locations.forEach(location => {
            $('#depart_location').append(new Option(location, location));
            $('#destination_location').append(new Option(location, location));
        });

        $('#datetimepicker1').datetimepicker({
            format: 'DD-MM-YYYY'
        });

        // Set default date to today and prevent selecting past dates
        document.getElementById('departDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('departDate').setAttribute('min', new Date().toISOString().split('T')[0]);

        // Common method to apply filters
        function applyFilters() {
            const filterData = $('#filter-form').serializeArray().reduce((acc, field) => {
                acc[field.name] = field.value;
                return acc;
            }, {});

            // Convert multi-select to proper array format
            filterData.depart_location = $('#depart_location').val();
            filterData.destination_location = $('#destination_location').val();

            const selectedDate = $('#departDate').val();
            filterData.date = selectedDate;

            // Get the current page number from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = urlParams.get('page') || 1;
            filterData.page = currentPage;

            $.ajax({
                url: "{{ url_for('bookings.filter_bookings') }}",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filterData),
                success: function (response) {
                    $('#filteredResults').html(response.html); // Updates filtered results
                    $('#filterModal').modal('hide');
                    // Hide pagination if filters are applied
                    if (filterData.depart_location.length > 0 || filterData.destination_location.length > 0 || filterData.min_fair_cost || filterData.max_fair_cost) {
                        $('.pagination').hide();
                    } else {
                        $('.pagination').show();
                    }
                },
                error: function () {
                    alert('Error applying filters. Please try again');
                }
            });
        }


        // Event listener for applying filters
        $('#apply-filters').click(applyFilters);

        // Event listener for resetting filters
        $('#reset-filters').click(function () {
            $('#filter-form')[0].reset(); // Reset filter modal
            applyFilters(); // Re-show all listings
        });

        // Event listener for date picker change
        $('#departDate').change(applyFilters);

        // Reset date functionality
        document.getElementById('resetDate').addEventListener('click', function() {
            document.getElementById('departDate').value = new Date().toISOString().split('T')[0];
            applyFilters();
        });

        $('#imageModal .btn-close, #imageModal .btn-secondary').on('click', function() {
            $('#imageModal').modal('hide');
        });
    });

    // Shows pop-up with images attached to specific booking
    function showModal(imageUrls) {
        var carouselInner = document.getElementById('carouselInner');
        var carouselIndicators = document.getElementById('carouselIndicators');
        carouselInner.innerHTML = '';
        carouselIndicators.innerHTML = '';

        imageUrls.forEach((imageUrl, index) => {
            var activeClass = (index === 0) ? ' active' : '';

            // Create carousel item
            var div = document.createElement('div');
            div.className = 'carousel-item' + activeClass;
            var img = document.createElement('img');
            img.className = 'd-block w-100';
            img.src = imageUrl;
            div.appendChild(img);
            carouselInner.appendChild(div);

            // Create carousel indicators
            var li = document.createElement('li');
            li.setAttribute('data-bs-target', '#carouselExampleIndicators');
            li.setAttribute('data-bs-slide-to', index);
            if (index === 0) {
                li.className = 'active';
            }
            carouselIndicators.appendChild(li);
        });

        var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        imageModal.show();
    }

    // Set date field and attach reset button
    document.getElementById('resetDate').addEventListener('click', function() {
        document.getElementById('departDate').value = new Date().toISOString().split('T')[0];
    });

    // Prevent selecting past dates
    document.getElementById('departDate').setAttribute('min', new Date().toISOString().split('T')[0]);

    // Set default date to today
    document.getElementById('departDate').value = new Date().toISOString().split('T')[0];
</script>

</body>
</html>
{% endblock %}
